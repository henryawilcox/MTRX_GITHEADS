/**
******************************************************************************
* @file : main.c
* @author : Auto-generated by STM32CubeIDE
* @brief : Main program body adapted for double-buffered interrupt UART
******************************************************************************
* @attention
*
* Copyright (c) 2023 STMicroelectronics.
* All rights reserved.
*
* This software is licensed under terms that can be found in the LICENSE file
* in the root directory of this software component.
* If no LICENSE file comes with this software, it is provided AS-IS.
*
******************************************************************************
*/

#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>

#include "serial.h"
#include "stm32f303xc.h"
#include "serial_interrupt.h"

#if !defined(__SOFT_FP__) && defined(__ARM_FP)
#warning "FPU is not initialized, but the project is compiling for an FPU. Please initialize the FPU before use."
#endif

void completion_callback(uint8_t length, uint8_t *string_buffer) {
    // This will be called when a complete string has been received
    // Note: parameter order changed to match the new implementation

    // Ensure null termination for safety
    string_buffer[length] = '\0';

    // Echo back the received string
    SerialOutputString((uint8_t*)"You entered: ", &USART1_PORT);
    SerialOutputString(string_buffer, &USART1_PORT);
    SerialOutputString((uint8_t*)"\r\n", &USART1_PORT);
    SerialOutputString((uint8_t*)"Characters received: ", &USART1_PORT);

    // Convert chars_read to string and display
    char num_str[10];
    sprintf(num_str, "%d", length);
    SerialOutputString((uint8_t*)num_str, &USART1_PORT);
    SerialOutputString((uint8_t*)"\r\n\r\n", &USART1_PORT);

    // Prompt for next input
    SerialOutputString((uint8_t*)"Enter text ('\\r' to terminate):\r\n", &USART1_PORT);
}

int main(void) {
    // Initialize the serial port with a baud rate of 115200
    SerialInitialise(BAUD_115200, &USART1_PORT, &completion_callback);

    // Send initial welcome message
    SerialOutputString((uint8_t*)"\r\n\r\n============================\r\n", &USART1_PORT);
    SerialOutputString((uint8_t*)"UART INTERRUPT DEMO\r\n", &USART1_PORT);
    SerialOutputString((uint8_t*)"Double-buffered receiver active\r\n", &USART1_PORT);
    SerialOutputString((uint8_t*)"============================\r\n\r\n", &USART1_PORT);
    SerialOutputString((uint8_t*)"Enter text ('\\r' to terminate):\r\n", &USART1_PORT);

    // Enable the serial interrupt system
    EnableSerialInterrupts(&USART1_PORT);

    /* Loop forever - everything happens in interrupts */
    for(;;) {
        // Application can perform other tasks here
        // Could include sleep modes for power saving
    }
}
