/**
******************************************************************************
* @file : main.c
* @author : Auto-generated by STM32CubeIDE
* @brief : Main program body
******************************************************************************
* @attention
*
* Copyright (c) 2023 STMicroelectronics.
* All rights reserved.
*
* This software is licensed under terms that can be found in the LICENSE file
* in the root directory of this software component.
* If no LICENSE file comes with this software, it is provided AS-IS.
*
******************************************************************************
*/

#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>

#include "serial.h"
#include "stm32f303xc.h"

#if !defined(__SOFT_FP__) && defined(__ARM_FP)
#warning "FPU is not initialized, but the project is compiling for an FPU. Please initialize the FPU before use."
#endif

void finished_transmission(uint32_t bytes_sent) {
    // This function will be called after a transmission is complete
    volatile uint32_t test = 0;
    // make a very simple delay
    for (volatile uint32_t i = 0; i < 0x8ffff; i++) {
        // waste time !
    }
}

void CompletionCallback(uint8_t *data, uint16_t length) {
    SerialOutputString((uint8_t*)"\r\n", &USART1_PORT);
    SerialOutputString(data, &USART1_PORT); // Send the received string over USART

    char length_str[32]; // Buffer to hold the string representation of the length
    sprintf(length_str, " || String has %d characters ||\r\n", length); // Convert length to string

    SerialOutputString((uint8_t *)length_str, &USART1_PORT); // Send the length over USART
    SerialOutputString((uint8_t*)"\r\nEnter text (press # to terminate):\r\n", &USART1_PORT);
}


int main(void)
{
    // Initialize the serial port with a baud rate of 115200
    SerialInitialise(BAUD_115200, &USART1_PORT, &CompletionCallback);

    // Send initial welcome message
    SerialOutputString((uint8_t*)"Welcome to UART Interface\r\n", &USART1_PORT);
    SerialOutputString((uint8_t*)"Enter text (press Enter to terminate):\r\n", &USART1_PORT);

    /* Loop forever */
    for(;;) {
    	SerialInputString(&USART1_PORT);
    }
}
